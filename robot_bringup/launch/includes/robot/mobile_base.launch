<launch>
  <!-- Arguments -->
  <arg name="external_manager" default="false"/>
  <arg name="manager"          default="mobile_base_nodelet_manager"/>

  <!-- Standalone nodelet manager -->
  <node unless="$(arg external_manager)" pkg="nodelet" type="nodelet" name="$(arg manager)" args="manager" required="true" machine="robot">
    <param name="num_worker_threads" value="8" />
  </node>

  <!-- Mobile base -->
  <node pkg="nodelet" type="nodelet" name="mobile_base" args="load kobuki_node/KobukiNodelet $(arg manager)" machine="robot">
    <rosparam file="$(find robot_bringup)/params/mobile_base/mobile_base.yaml" command="load"/>
    <param name="publish_tf"  value="true"/>
    
    <remap from="mobile_base/odom"         to="odom"/>
    <remap from="mobile_base/joint_states" to="joint_states"/>
  </node>
  
  <!-- Diagnostic aggregator -->
  <node pkg="diagnostic_aggregator" type="aggregator_node" name="diagnostic_aggregator" machine="robot">
    <rosparam command="load" file="$(find robot_bringup)/params/mobile_base/diagnostics.yaml" />
  </node>

  <!-- Velocity command multiplexer -->
  <!-- Note: Subscribes to the input topics defined below in yaml_cfg_data -->
  <node pkg="nodelet" type="nodelet" name="cmd_vel_mux" args="load yocs_cmd_vel_mux/CmdVelMuxNodelet $(arg manager)" respawn="true" machine="robot">
    <rosparam param="yaml_cfg_data">
      '{
        subscribers: [
          { name: "Safety Controller", topic: "input/safety",     timeout: 0.2, priority: 100 },
          { name: "Teleoperation",     topic: "input/teleop",     timeout: 0.2, priority: 50 },
          { name: "Docking",           topic: "input/docking",    timeout: 0.2, priority: 25 },          
          { name: "Navigation",        topic: "input/navigation", timeout: 0.2, priority: 1 }
        ],
        publisher: "output/cmd_vel"
      }'
    </rosparam>

    <remap from="cmd_vel_mux/output/cmd_vel" to="mobile_base/commands/velocity"/>
  </node>
  
  <!-- Safety controller -->
  <node pkg="nodelet" type="nodelet" name="safety_controller" args="load kobuki_safety_controller/SafetyControllerNodelet $(arg manager)" machine="robot">
    <remap from="safety_controller/cmd_vel"           to="cmd_vel_mux/input/safety"/>
    <remap from="safety_controller/events/bumper"     to="mobile_base/events/bumper"/>
    <remap from="safety_controller/events/cliff"      to="mobile_base/events/cliff"/>
    <remap from="safety_controller/events/wheel_drop" to="mobile_base/events/wheel_drop"/>
  </node>

  <!-- Autodocking -->
  <node pkg="nodelet" type="nodelet" name="dock_drive" args="load kobuki_auto_docking/AutoDockingNodelet $(arg manager)" machine="robot">
    <!-- minimum linear velocity in m/s -->
    <param name="min_abs_v" type="double" value="0.01" />
    <!-- minimum angular velocity in rad/s -->
    <param name="min_abs_w" type="double" value="0.1" />

    <remap from="dock_drive/odom"        to="odom"/>
    <remap from="dock_drive/core"        to="mobile_base/sensors/core"/>
    <remap from="dock_drive/dock_ir"     to="mobile_base/sensors/dock_ir"/>
    <remap from="dock_drive/motor_power" to="mobile_base/commands/motor_power"/>
    <remap from="dock_drive/velocity"    to="cmd_vel_mux/input/docking"/>
  </node>
</launch>